

CC=riscv64-linux-gnu-gcc-8
AS=riscv64-linux-gnu-as
LD=riscv64-linux-gnu-ld
OBJCOPY=riscv64-linux-gnu-objcopy
OBJDUMP=riscv64-linux-gnu-objdump
SIZE=riscv64-linux-gnu-size

#LDFLAGS+=-nostdlib -Wl,-Ttext=0x0,-Tdata=0x8000
LDFLAGS+=-nostdlib -Wl,-Ttext=0x0

CFLAGS+=-ffreestanding -fno-pic
CFLAGS+=-march=rv32i -mabi=ilp32
CFLAGS+=-Wl,--no-relax			# see: https://github.com/riscv/riscv-gcc/issues/120

ASFLAGS+=$(CFLAGS)

CLEAN_DIRS=$(SUBDIRS:%=clean-%)
ALL_DIRS=$(SUBDIRS:%=all-%)

OBJDUMPFLAGS+=-Mnumeric,no-aliases

.PHONY: all clean world $(CLEAN_DIRS) $(ALL_DIRS)


%.bin : %
	$(OBJCOPY) $< -O binary $@

%.lst : %
	$(OBJDUMP) $(OBJDUMPFLAGS) -dr $< > $<.lst

% : %.o
	$(LINK.c) $(LDFLAGS) -o $@ $^ $(LDLIBS)
	$(SIZE) -x -A $@

%.s: %.c
	$(COMPILE.c) -S -o $@ $<

%.srec: %
	$(OBJCOPY) $< -O srec $@ 




all:: $(ALL_DIRS)

clean:: $(CLEAN_DIRS)

$(ALL_DIRS)::
	$(MAKE) -C $(@:all-%=%) all

$(CLEAN_DIRS)::
	$(MAKE) -C $(@:clean-%=%) clean

world:: clean all
